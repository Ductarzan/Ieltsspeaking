<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI English - Luyện thi IELTS Speaking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
        }
        .gradient-text {
            background: linear-gradient(90deg, #4361EE, #7209B7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .section-bg-pink {
            background-color: #FFF5F6;
        }
        .cta-bg-dark {
            background-color: #0B051D;
        }
        .loader {
            border: 4px solid #e0e0e0;
            border-top: 4px solid #4361EE;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pulsing-mic {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.7); }
            70% { box-shadow: 0 0 0 25px rgba(67, 97, 238, 0); }
            100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
        }
        .sidebar-item.active { background-color: #dc2626; color: white; }
        .sidebar-item.active .fa-solid { color: white; }
        .progress-bar-bg { background-color: #e5e7eb; }
        .progress-bar-fill { background-color: #ef4444; }
        .tab.active { border-bottom: 2px solid #dc2626; color: #dc2626; }
        .tab { border-bottom: 2px solid transparent; }
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <!-- Header chung -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="nav-link font-bold text-2xl" data-page="home">AI<span class="text-blue-600">English</span></a>
            <div class="hidden md:flex items-center space-x-6">
                <a href="#" class="text-slate-600 hover:text-blue-600">Features</a>
                <a href="#" class="text-slate-600 hover:text-blue-600">Pricing</a>
                <a href="#" class="text-slate-600 hover:text-blue-600">Testimonials</a>
            </div>
            <button class="nav-link bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-lg" data-page="login">Start For Free</button>
        </nav>
    </header>

    <main id="app">
        <!-- Trang chủ -->
        <div id="home-page" class="page active">
            <section class="py-20">
                <div class="container mx-auto px-6 text-center">
                    <h1 class="text-4xl md:text-6xl font-extrabold text-slate-900 mb-4 leading-tight">Get Your IELTS Speaking Score<br>Instantly with <span class="gradient-text">AI</span></h1>
                    <p class="text-slate-600 text-lg mb-8 max-w-2xl mx-auto">Detailed band score in Fluency, Pronunciation, Grammar, and Vocabulary within 2 minutes.</p>
                    <button class="nav-link bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-lg shadow-lg" data-page="login">Take a Free Mock Test</button>
                    <div class="mt-12">
                        <img src="https://placehold.co/800x450/E2E8F0/4A5568?text=Giao+diện+chấm+điểm" alt="Giao diện chấm điểm" class="rounded-xl shadow-2xl mx-auto">
                    </div>
                </div>
            </section>
            
            <section class="section-bg-pink py-20">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl md:text-4xl font-bold text-center text-slate-900 mb-12">What Makes AI-Scored Evaluation Different?</h2>
                    <div class="grid md:grid-cols-2 gap-10 items-center mb-16">
                        <div>
                            <h3 class="text-2xl font-bold mb-3">Instant, Detailed Feedback</h3>
                            <p class="text-slate-600">No more waiting for days. Our AI provides a comprehensive breakdown of your performance across all four marking criteria immediately after you speak.</p>
                        </div>
                        <img src="https://placehold.co/500x300/FFFFFF/4A5568?text=Feedback+chi+tiết" alt="Feedback chi tiết" class="rounded-lg shadow-lg">
                    </div>
                     <div class="grid md:grid-cols-2 gap-10 items-center">
                        <img src="https://placehold.co/500x300/FFFFFF/4A5568?text=Phân+tích+chuyên+sâu" alt="Phân tích chuyên sâu" class="rounded-lg shadow-lg">
                        <div>
                            <h3 class="text-2xl font-bold mb-3">In-depth Analysis</h3>
                            <p class="text-slate-600">Go beyond the score. Understand your pacing, pauses, intonation, and get actionable advice to target your specific weaknesses.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="cta-bg-dark text-white py-20">
                <div class="container mx-auto px-6 text-center">
                    <h2 class="text-3xl md:text-4xl font-bold mb-4">Master IELTS Speaking</h2>
                    <p class="mb-8">Practice with unlimited topics and track your progress.</p>
                    <button class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-lg text-lg" data-page="login">Start Now for $1.99</button>
                </div>
            </section>
            
            <footer class="bg-slate-900 text-slate-400 py-12">
                <div class="container mx-auto px-6 text-center">
                    <p>&copy; 2024 AI English. All rights reserved.</p>
                </div>
            </footer>
        </div>

        <!-- Trang đăng nhập -->
        <div id="login-page" class="page">
            <div class="flex items-center justify-center min-h-screen bg-gray-50">
                <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-center text-slate-900">Welcome Back</h2>
                    <p class="text-center text-slate-500">Login to start your test</p>
                    <div class="space-y-4">
                        <div>
                            <label for="email" class="text-sm font-medium text-slate-700">Email Address</label>
                            <input type="email" id="email" class="w-full px-4 py-2 mt-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="you@example.com" value="test@example.com">
                        </div>
                        <div>
                            <label for="password" class="text-sm font-medium text-slate-700">Password</label>
                            <input type="password" id="password" class="w-full px-4 py-2 mt-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="********" value="password">
                        </div>
                    </div>
                    <button id="login-btn" class="w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                        Login & Start Test
                    </button>
                </div>
            </div>
        </div>

        <!-- Module làm bài thi -->
        <div id="test-module" class="page">
            <div class="flex flex-col items-center justify-center min-h-screen bg-gray-50">
                 <!-- Màn hình bắt đầu thi -->
                <div id="start-test-view" class="text-center w-full max-w-3xl">
                    <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto border border-slate-200">
                        <h2 id="question-title" class="text-2xl font-semibold mb-4 text-slate-800"></h2>
                        <p class="text-slate-600 mb-2">You should say:</p>
                        <ul id="question-cues" class="list-disc list-inside text-slate-500 mb-6 text-left"></ul>
                        <button id="start-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 text-lg shadow-md">
                            Start Speaking (2 minutes)
                        </button>
                    </div>
                </div>
                <!-- Màn hình ghi âm -->
                <div id="recording-view" class="hidden text-center">
                    <div class="mb-8 w-28 h-28 bg-blue-600 rounded-full flex items-center justify-center mx-auto pulsing-mic">
                        <i class="fa-solid fa-microphone-lines text-5xl text-white"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-2 text-slate-900">Recording...</h2>
                    <p class="text-slate-500 text-lg mb-4">Answer the given question.</p>
                    <div id="timer" class="text-5xl font-bold text-blue-500 mb-8">2:00</div>
                    <button id="stop-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 text-lg shadow-md">
                        Stop & Submit
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Màn hình chờ chấm điểm -->
        <div id="loading-page" class="page">
             <div class="flex flex-col items-center justify-center min-h-screen text-center">
                <div class="loader mx-auto mb-6"></div>
                <h2 class="text-3xl font-bold mb-2 text-slate-900">Analyzing your speech...</h2>
                <p class="text-slate-500">The AI is listening and grading. This might take a moment.</p>
            </div>
        </div>

        <!-- Màn hình kết quả -->
        <div id="results-page" class="page">
            <div class="w-full max-w-7xl mx-auto my-12 bg-white p-6 md:p-8 rounded-2xl shadow-2xl border border-slate-200">
                <div class="flex border-b border-slate-200 mb-6">
                    <div class="tab active flex items-center py-3 px-4">
                        <i class="fa-solid fa-file-lines mr-2"></i>
                        <span class="font-semibold">Part 2</span>
                        <span id="part2-score" class="ml-2 bg-red-100 text-red-700 font-bold text-sm px-2 py-0.5 rounded-full">0.0</span>
                    </div>
                </div>
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- Left Sidebar -->
                    <div class="w-full lg:w-1/4">
                        <h3 class="font-bold text-lg mb-2">Score Breakdown</h3>
                        <p class="text-sm text-slate-500 mb-4">Focus on your Intonation to sound more natural when you speak.</p>
                        <div class="space-y-2">
                           <div id="sb-pronunciation" class="sidebar-item flex justify-between items-center p-3 rounded-lg cursor-pointer transition-colors duration-200 hover:bg-slate-100"> <div class="flex items-center"> <i class="fa-solid fa-microphone-lines mr-3 text-red-500 w-6 text-center"></i> <div> <p class="font-semibold">Pronunciation</p> <p id="pronunciation-level" class="text-sm text-slate-500"></p> </div> </div> <span id="pronunciation-percentage" class="font-bold text-lg"></span> </div>
                           <div id="sb-intonation" class="sidebar-item flex justify-between items-center p-3 rounded-lg cursor-pointer transition-colors duration-200 hover:bg-slate-100"> <div class="flex items-center"> <i class="fa-solid fa-wave-square mr-3 text-red-500 w-6 text-center"></i> <div> <p class="font-semibold">Intonation</p> <p id="intonation-level" class="text-sm text-slate-500"></p> </div> </div> <span id="intonation-percentage" class="font-bold text-lg"></span> </div>
                           <div id="sb-fluency" class="sidebar-item active flex justify-between items-center p-3 rounded-lg cursor-pointer transition-colors duration-200"> <div class="flex items-center"> <i class="fa-solid fa-comments mr-3 text-red-500 w-6 text-center"></i> <div> <p class="font-semibold">Fluency</p> <p id="fluency-level" class="text-sm"></p> </div> </div> <i class="fa-solid fa-chevron-right"></i> </div>
                           <div id="sb-grammar" class="sidebar-item flex justify-between items-center p-3 rounded-lg cursor-pointer transition-colors duration-200 hover:bg-slate-100"> <div class="flex items-center"> <i class="fa-solid fa-spell-check mr-3 text-red-500 w-6 text-center"></i> <div> <p class="font-semibold">Grammar</p> <p id="grammar-level" class="text-sm text-slate-500"></p> </div> </div> <span id="grammar-percentage" class="font-bold text-lg"></span> </div>
                           <div id="sb-vocabulary" class="sidebar-item flex justify-between items-center p-3 rounded-lg cursor-pointer transition-colors duration-200 hover:bg-slate-100"> <div class="flex items-center"> <i class="fa-solid fa-book-open mr-3 text-red-500 w-6 text-center"></i> <div> <p class="font-semibold">Vocabulary</p> <p id="vocabulary-level" class="text-sm text-slate-500"></p> </div> </div> <span id="vocabulary-percentage" class="font-bold text-lg"></span> </div>
                        </div>
                    </div>
                    <!-- Right Content -->
                    <div class="w-full lg:w-3/4 p-6 bg-slate-50 rounded-xl">
                        <div id="fluency-content">
                            <div class="flex items-center justify-between mb-4"><div><p class="text-sm text-slate-500">Your Level</p><h4 id="fluency-content-level" class="text-2xl font-bold"></h4></div><div class="text-right"><p id="fluency-percentage" class="text-3xl font-bold text-red-500"></p></div></div>
                            <div class="w-full progress-bar-bg rounded-full h-2.5 mb-4"><div id="fluency-progress" class="progress-bar-fill h-2.5 rounded-full"></div></div>
                            <p id="fluency-feedback" class="text-slate-600 mb-8"></p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"><div class="text-center"><p class="text-sm text-slate-500">Pace</p><p id="pace-label" class="font-semibold text-lg"></p></div><div class="text-center"><p class="text-sm text-slate-500">Pausing</p><p id="pausing-label" class="font-semibold text-lg"></p></div><div class="text-center"><p class="text-sm text-slate-500">Hesitations</p><p id="hesitations-label" class="font-semibold text-lg"></p></div></div>
                            <div class="flex flex-col md:flex-row items-center gap-6 mb-8"><div class="w-full md:w-1/3"><div class="relative w-full" style="padding-bottom: 50%;"><canvas id="wpm-gauge"></canvas></div></div><div class="w-full md:w-2/3"><h5 class="font-bold text-lg">Pacing</h5><p id="pacing-feedback" class="text-slate-600"></p></div></div>
                            <h5 class="font-bold text-lg mb-4">An overview</h5>
                            <div class="h-64"><canvas id="wpm-chart"></canvas></div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-8">
                    <button id="try-again-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 shadow-md">Take Another Test</button>
                </div>
            </div>
        </div>

        <!-- Màn hình lỗi -->
        <div id="error-page" class="page">
            <div class="flex flex-col items-center justify-center min-h-screen text-center">
                <h2 class="text-3xl font-bold text-red-500 mb-4">An Error Occurred</h2>
                <p id="error-message" class="text-slate-500 mb-6"></p>
                <button id="retry-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg">Try Again</button>
            </div>
        </div>
    </main>

    <script>
        // --- State and Config ---
        const API_KEY = "AIzaSyCwe_41_32LWIslaALPdMe-8KzqodA-Od8";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
        const TEST_DURATION = 120; // 2 minutes

        let mediaRecorder;
        let audioChunks = [];
        let timerInterval;
        let wpmChartInstance, wpmGaugeInstance;
        let currentQuestion = {};
        
        const questions = [
            { title: "Describe a historical place...", cues: ["what it is", "where it is", "its importance", "how you feel about it."] },
            { title: "Describe a book you recently read.", cues: ["what kind of book", "what it's about", "what you learned", "why you'd recommend it."] },
            { title: "Describe a memorable trip.", cues: ["where you went", "who with", "what you did", "why it was memorable."] }
        ];

        // --- Page Navigation ---
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');

        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.remove('active');
            });
            const newPage = document.getElementById(pageId + '-page') || document.getElementById(pageId);
             if (newPage) {
                newPage.classList.add('active');
                window.scrollTo(0, 0);
            }
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = e.currentTarget.dataset.page;
                showPage(pageId);
            });
        });

        // --- App Logic ---
        document.getElementById('login-btn').addEventListener('click', () => {
            loadQuestion();
            showPage('test-module');
        });
        
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('start-test-view').classList.add('hidden');
            document.getElementById('recording-view').classList.remove('hidden');
            startRecording();
        });

        document.getElementById('stop-btn').addEventListener('click', stopRecording);
        document.getElementById('try-again-btn').addEventListener('click', () => {
             loadQuestion();
             showPage('test-module');
        });
        document.getElementById('retry-btn').addEventListener('click', () => {
             loadQuestion();
             showPage('test-module');
        });


        // --- Audio & Timer ---
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = handleRecordingStop;
                mediaRecorder.start();
                startTimer();
            } catch (err) {
                console.error("Mic access error:", err);
                showError("Could not access the microphone. Please grant permission and try again.");
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                clearInterval(timerInterval);
            }
        }
        
        function handleRecordingStop() {
            showPage('loading');
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            audioChunks = [];
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = () => {
                const base64Audio = reader.result.split(',')[1];
                getIeltsScore(base64Audio);
            };
        }

        function startTimer() {
            let timeLeft = TEST_DURATION;
            const timerEl = document.getElementById('timer');
            const updateDisplay = () => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = (timeLeft % 60).toString().padStart(2, '0');
                timerEl.textContent = `${minutes}:${seconds}`;
            };
            updateDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateDisplay();
                if (timeLeft <= 0) stopRecording();
            }, 1000);
        }

        // --- API Call ---
        async function getIeltsScore(base64Audio) {
            const prompt = `
                You are an expert IELTS examiner. Your task is to evaluate a user's spoken response to an IELTS Speaking Part 2 question.
                The question asked was: "${currentQuestion.title}"
                
                First, transcribe the user's audio response.
                
                Then, evaluate the transcribed response based on the four official IELTS Speaking assessment criteria. For each criterion, provide a score (1.0-9.0), a percentage (0-100), and a level (e.g., 'Advanced', 'Upper Intermediate').
                
                For 'Fluency', also analyze:
                - Pace: Average words per minute (WPM). Categorize it as 'Slow', 'Natural', or 'Fast'.
                - Pausing: Categorize as 'Appropriate', 'Too much', 'Too little'.
                - Hesitations: Categorize as 'Few', 'Some', 'Frequent'.
                - WPM over time: Provide an array of WPM values for every 10-second interval of the speech.
                
                Provide an overall band score.
                Provide detailed feedback for each criterion and overall suggestions for improvement.

                Your final output MUST be a valid JSON object. Do not include any text or markdown formatting. 
                It is CRITICAL that ALL keys in the example structure are present in your final output. If a value cannot be determined, use a default like 0, "N/A", or an empty string.
                Example structure:
                {
                  "overall_score": 7.5,
                  "pronunciation": { "score": 7.0, "percentage": 84, "level": "Advanced", "feedback": "..." },
                  "intonation": { "score": 6.5, "percentage": 63, "level": "Intermediate", "feedback": "..." },
                  "fluency": { "score": 7.5, "level": "Upper Intermediate", "percentage": 72, "feedback": "...", "pace_wpm": 157, "pace_label": "Natural", "pausing_label": "Acceptable", "hesitations_label": "Frequent", "pacing_feedback": "...", "wpm_timeline": [90, 110, 150] },
                  "grammar": { "score": 8.0, "percentage": 81, "level": "Advanced", "feedback": "..." },
                  "vocabulary": { "score": 7.0, "percentage": 49, "level": "Lower Intermediate", "feedback": "..." },
                  "transcript": "The full transcribed text of the user's speech.",
                  "suggestions": "Overall suggestions for improvement."
                }
            `;
            const payload = {
                contents: [{ parts: [{ text: prompt }, { inline_data: { mimeType: "audio/webm", data: base64Audio } }] }],
                generationConfig: { "responseMimeType": "application/json" }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API Error ${response.status}: ${errorBody.error?.message || 'Unknown error'}`);
                }
                const result = await response.json();
                
                let parsedData;
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    try {
                        parsedData = JSON.parse(result.candidates[0].content.parts[0].text);
                    } catch (e) {
                        throw new Error("API returned invalid JSON.");
                    }
                    displayResults(parsedData);
                } else {
                    throw new Error("Invalid API response format.");
                }
            } catch (error) {
                console.error("API call failed:", error);
                showError(`Failed to analyze speech. ${error.message}. Please try again.`);
            }
        }

        // --- UI Updates & Rendering ---
        function displayResults(data) {
            document.getElementById('part2-score').textContent = (data.overall_score || 0).toFixed(1);

            // Sidebar data
            document.getElementById('pronunciation-level').textContent = data.pronunciation?.level || 'N/A';
            document.getElementById('pronunciation-percentage').textContent = data.pronunciation?.percentage ? `${data.pronunciation.percentage}%` : '-';
            
            document.getElementById('intonation-level').textContent = data.intonation?.level || 'N/A';
            document.getElementById('intonation-percentage').textContent = data.intonation?.percentage ? `${data.intonation.percentage}%` : '-';

            document.getElementById('fluency-level').textContent = data.fluency?.level || 'N/A';
            
            document.getElementById('grammar-level').textContent = data.grammar?.level || 'N/A';
            document.getElementById('grammar-percentage').textContent = data.grammar?.percentage ? `${data.grammar.percentage}%` : '-';

            document.getElementById('vocabulary-level').textContent = data.vocabulary?.level || 'N/A';
            document.getElementById('vocabulary-percentage').textContent = data.vocabulary?.percentage ? `${data.vocabulary.percentage}%` : '-';

            // Fluency Content
            const f = data.fluency || {}; // Use an empty object as a fallback
            document.getElementById('fluency-content-level').textContent = f.level || 'N/A';
            document.getElementById('fluency-percentage').textContent = f.percentage ? `${f.percentage}%` : '-';
            document.getElementById('fluency-progress').style.width = `${f.percentage || 0}%`;
            document.getElementById('fluency-feedback').textContent = f.feedback || 'No feedback available.';
            document.getElementById('pace-label').textContent = f.pace_label || 'N/A';
            document.getElementById('pausing-label').textContent = f.pausing_label || 'N/A';
            document.getElementById('hesitations-label').textContent = f.hesitations_label || 'N/A';
            document.getElementById('pacing-feedback').textContent = f.pacing_feedback || 'No feedback available.';

            renderWpmGauge(f.pace_wpm || 0);
            renderWpmChart(f.wpm_timeline || []);

            showPage('results');
        }
        
        function renderWpmGauge(wpm) {
            const ctx = document.getElementById('wpm-gauge').getContext('2d');
            if (wpmGaugeInstance) wpmGaugeInstance.destroy();
            
            const data = {
                datasets: [{
                    value: wpm,
                    minValue: 50,
                    data: [60, 60, 130], // Slow, Natural, Fast ranges
                    backgroundColor: ['#fecaca', '#a7f3d0', '#fecaca'],
                }]
            };

            wpmGaugeInstance = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    rotation: -90,
                    circumference: 180,
                    cutout: '60%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    responsive: true,
                    maintainAspectRatio: false,
                }
            });
        }
        
        function renderWpmChart(wpmData) {
            const ctx = document.getElementById('wpm-chart').getContext('2d');
            if (wpmChartInstance) wpmChartInstance.destroy();

            const labels = wpmData.map((_, i) => `${i * 10}s`);
            
            wpmChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'WPM',
                        data: wpmData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#ef4444',
                        pointRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Words Per Minute' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            showPage('error');
        }
        
        function loadQuestion() {
            currentQuestion = questions[Math.floor(Math.random() * questions.length)];
            document.getElementById('question-title').textContent = currentQuestion.title;
            const cuesEl = document.getElementById('question-cues');
            cuesEl.innerHTML = '';
            currentQuestion.cues.forEach(cue => {
                const li = document.createElement('li');
                li.textContent = cue;
                cuesEl.appendChild(li);
            });
            // Reset test views
            document.getElementById('start-test-view').classList.remove('hidden');
            document.getElementById('recording-view').classList.add('hidden');
        }

        // --- Initial Load ---
        window.onload = () => {
            showPage('home');
        };

    </script>
</body>
</html>
